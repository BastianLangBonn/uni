#include <stdio.h>
#include "constants.h"
#include "motor.h"

extern double currentPwmSignal;

void readButton(){
    //pthread_mutex_lock(&pwmMutex);
    double pwmSignal = currentPwmSignal;
    //pthread_mutex_unlock(&pwmMutex);
    if(digitalRead(GPIO_BUTTON) == 1){
        pwmSignal += STEP_SIZE;
        if(pwmSignal > 1){ 
            pwmSignal = 1;
        }
        //pthread_mutex_lock(&pwmMutex);
        if(currentPwmSignal != pwmSignal){
            currentPwmSignal = pwmSignal;
            notifyPwmSignalChange();
        }        
        //pthread_mutex_unlock(&pwmMutex);
        
	    delay(200); //Delay needed for button press
	}
}

PI_THREAD (button){
    logToConsole("Button Thread Started");
    notifyPwmSignalChange();
    while(1){
	    readButton();	
	    delay(SENSOR_UPDATE); //no busy-waiting	
    }
    logToConsole("Button Thread Ended");
}


